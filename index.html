<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Audio-Visual Global News Portal</title>
<style>
  :root{--bg:#f3f4f6;--card:#fff;--accent:#2563eb;--muted:#6b7280}
  body{font-family:Inter,Arial,Helvetica,sans-serif;margin:0;background:var(--bg);color:#111}
  header{background:#000;color:#fff;padding:18px;text-align:center}
  .controls{margin-top:10px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
  button{border:0;cursor:pointer;border-radius:8px;padding:8px 12px;font-size:14px}
  .lang{background:#e5e7eb;color:#111}
  .lang.active{background:var(--accent);color:#fff}
  .refresh{background:#10b981;color:#fff}
  .container{max-width:1100px;margin:18px auto;display:grid;grid-template-columns:2fr 1fr;gap:16px;padding:12px}
  main, aside{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  article{border-bottom:1px solid #eee;padding-bottom:12px;margin-bottom:12px}
  iframe{width:100%;height:250px;border-radius:8px;border:0}
  .error{background:#ef4444;color:#fff;padding:10px;text-align:center;border-radius:8px;margin:12px auto;max-width:1100px}
  .loader{color:var(--muted);text-align:center;padding:20px}
  a.read{color:var(--accent);text-decoration:underline;margin-left:8px}
</style>
</head>
<body>
  <header>
    <h1 style="margin:0 0 6px 0">AI Audio-Visual Global News Portal</h1>
    <div class="controls" id="controls">
      <button id="btn-en" class="lang active">English</button>
      <button id="btn-hi" class="lang">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</button>
      <button id="btn-ta" class="lang">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</button>
      <button id="btn-refresh" class="refresh">üîÑ Refresh</button>
    </div>
  </header>

  <div id="error" class="error" style="display:none"></div>

  <div class="container">
    <main id="news" aria-live="polite">
      <div class="loader" id="loader">Loading news‚Ä¶</div>
    </main>

    <aside>
      <h4 style="margin:0 0 8px 0">Live Video</h4>
      <div style="border-radius:8px;overflow:hidden">
        <iframe id="live" title="Live stream" allowfullscreen src=""></iframe>
      </div>
      <div id="updated" style="margin-top:12px;color:var(--muted);text-align:center">Last updated: ‚Äî</div>
    </aside>
  </div>

<script>
const state = {
  lang: 'en',
  endpoints: {
    en: 'https://api.rss2json.com/v1/api.json?rss_url=' + encodeURIComponent('https://feeds.bbci.co.uk/news/rss.xml'),
    hi: 'https://inshortsapi.vercel.app/news?category=national',
    ta: 'https://inshortsapi.vercel.app/news?category=national'
  },
  liveEmbeds: {
    en: 'https://www.bbc.com/news/av/embed/p08t2g54/53999932',
    hi: 'https://www.tv9hindi.com/live-tv',
    ta: 'https://www.24x7liveindia.com/embed/puthiyathalaimurai'
  }
};

const dom = {
  news: document.getElementById('news'),
  loader: document.getElementById('loader'),
  error: document.getElementById('error'),
  updated: document.getElementById('updated'),
  live: document.getElementById('live'),
  btnEn: document.getElementById('btn-en'),
  btnHi: document.getElementById('btn-hi'),
  btnTa: document.getElementById('btn-ta'),
  btnRefresh: document.getElementById('btn-refresh')
};

function setActiveButton() {
  [dom.btnEn, dom.btnHi, dom.btnTa].forEach(b => b.classList.remove('active'));
  if (state.lang === 'en') dom.btnEn.classList.add('active');
  else if (state.lang === 'hi') dom.btnHi.classList.add('active');
  else dom.btnTa.classList.add('active');
  dom.live.src = state.liveEmbeds[state.lang] || '';
}

dom.btnEn.addEventListener('click', () => { state.lang='en'; setActiveButton(); fetchAndRender();});
dom.btnHi.addEventListener('click', () => { state.lang='hi'; setActiveButton(); fetchAndRender();});
dom.btnTa.addEventListener('click', () => { state.lang='ta'; setActiveButton(); fetchAndRender();});
dom.btnRefresh.addEventListener('click', () => fetchAndRender());

function showError(msg) {
  dom.error.style.display = 'block';
  dom.error.textContent = msg;
}

function hideError() {
  dom.error.style.display = 'none';
  dom.error.textContent = '';
}

function clearNews() {
  dom.news.innerHTML = '';
}

function sanitize(text) {
  if (!text) return '';
  return text.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

async function fetchAndRender() {
  hideError();
  clearNews();
  dom.loader.style.display = 'block';
  dom.updated.textContent = 'Last updated: ‚Äî';

  const url = state.endpoints[state.lang];
  try {
    let articles = [];
    const res = await fetch(url, {cache: 'no-store'});
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();

    if (state.lang === 'en') {
      articles = (data.items || []).slice(0, 12).map(it => ({
        title: it.title || 'Untitled',
        description: it.description || it.content || '',
        link: it.link || ''
      }));
    } else {
      const list = (data.results && data.results.length) ? data.results : (data.data || []);
      articles = (list || []).slice(0, 12).map(it => ({
        title: it.title || it.heading || 'Untitled',
        description: it.content || it.description || '',
        link: it.url || ''
      }));
    }

    if (!articles.length) throw new Error('No articles found');

    renderArticles(articles);
    dom.updated.textContent = 'Last updated: ' + new Date().toLocaleTimeString();
  } catch (err) {
    console.error('fetch error', err);
    showError('Failed to load news. Try Refresh or check your internet.');
    dom.loader.style.display = 'none';
  }
}

function createListenButton(title, desc) {
  const btn = document.createElement('button');
  btn.textContent = 'üîä Listen Full';
  btn.style.background = '#2563eb';
  btn.style.color = '#fff';
  btn.style.borderRadius = '6px';
  btn.addEventListener('click', () => speak(title, desc));
  return btn;
}

function renderArticles(articles) {
  dom.loader.style.display = 'none';
  dom.news.innerHTML = '';

  for (const a of articles) {
    const art = document.createElement('article');
    const h = document.createElement('h3');
    h.textContent = a.title || 'Untitled';
    art.appendChild(h);
    const p = document.createElement('p');
    p.innerHTML = sanitize(a.description || '').replace(/\n/g,'<br>');
    art.appendChild(p);
    const controls = document.createElement('div');
    controls.style.display = 'flex';
    controls.style.gap = '8px';
    controls.style.alignItems = 'center';
    controls.appendChild(createListenButton(a.title, a.description || ''));
    if (a.link) {
      const read = document.createElement('a');
      read.href = a.link;
      read.target = '_blank';
      read.className = 'read';
      read.textContent = 'Read more';
      controls.appendChild(read);
    }
    art.appendChild(controls);
    dom.news.appendChild(art);
  }
}

function getBestVoiceFor(lang) {
  const voices = speechSynthesis.getVoices();
  if (!voices || !voices.length) return null;
  if (lang === 'ta') {
    return voices.find(v => v.lang && v.lang.toLowerCase().startsWith('ta')) ||
           voices.find(v => v.lang && v.lang.toLowerCase().includes('en-in')) ||
           voices.find(v => v.lang && v.lang.toLowerCase().includes('en')) ||
           voices[0];
  } else if (lang === 'hi') {
    return voices.find(v => v.lang && v.lang.toLowerCase().startsWith('hi')) ||
           voices.find(v => v.name && v.name.toLowerCase().includes('hindi')) ||
           voices.find(v => v.lang && v.lang.toLowerCase().includes('en-in')) ||
           voices[0];
  } else {
    return voices.find(v => v.lang && v.lang.toLowerCase().includes('en-us')) ||
           voices.find(v => v.lang && v.lang.toLowerCase().includes('en')) ||
           voices[0];
  }
}

function speak(title, desc) {
  if (!('speechSynthesis' in window)) {
    alert('Text-to-speech not supported in this browser.');
    return;
  }
  const text = (title || '') + '. ' + (desc || '');
  if (!text.trim()) return;

  let voices = speechSynthesis.getVoices();
  if (!voices.length) {
    const maxWait = 800;
    const start = Date.now();
    const wait = () => new Promise(resolve => {
      if (speechSynthesis.getVoices().length) return resolve();
      const onChange = () => {
        if (speechSynthesis.getVoices().length) {
          speechSynthesis.onvoiceschanged = null;
          resolve();
        } else if (Date.now() - start > maxWait) {
          speechSynthesis.onvoiceschanged = null;
          resolve();
        }
      };
      speechSynthesis.onvoiceschanged = onChange;
      setTimeout(() => { speechSynthesis.onvoiceschanged = null; resolve(); }, maxWait);
    });
    wait().then(() => doSpeak(text));
  } else {
    doSpeak(text);
  }

  function doSpeak(textToSay) {
    const utt = new SpeechSynthesisUtterance(textToSay);
    utt.lang = (state.lang === 'hi') ? 'hi-IN' : (state.lang === 'ta') ? 'ta-IN' : 'en-US';
    const voice = getBestVoiceFor(state.lang);
    if (voice) utt.voice = voice;
    if (state.lang === 'ta') { utt.rate = 0.95; utt.pitch = 1.0; }
    else if (state.lang === 'hi') { utt.rate = 1.0; utt.pitch = 1.0; }
    else { utt.rate = 1.0; utt.pitch = 1.0; }
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utt);
  }
}

setActiveButton();
fetchAndRender();
if ('speechSynthesis' in window) {
  speechSynthesis.onvoiceschanged = () => { speechSynthesis.getVoices(); };
}
</script>
</body>
</html>
